<template>
  <div class="organ-details">
    <details-header
      :subtitle="pageData.fields.subtitle"
      :title="pageData.fields.name"
      :description="pageData.fields.description"
      :breadcrumb="breadcrumb"
    >
      <img slot="banner image" :src="bannerImage" :alt="bannerImageAlt" />
    </details-header>
    <detail-tabs
      :tabs="tabs"
      :active-tab="activeTab"
      class="container"
      @set-active-tab="setActiveTab"
    >
      <client-only placeholder="Loading viewer...">
        <div v-show="activeTab === '3DScaffold'" class="scaffold">
          <scaffold-vuer v-if="scaffold" :url="scaffold" />
          <p v-else>
            No 3D scaffold available
          </p>
        </div>
      </client-only>
      <dataset-search-results
        v-show="activeTab === 'datasets'"
        :table-data="datasets"
      />
      <project-search-results
        v-show="activeTab === 'projects'"
        :table-data="projects"
      />
    </detail-tabs>
  </div>
</template>

<script>
import { pathOr } from 'ramda'
import '@abi-software/scaffoldvuer'
import '@abi-software/scaffoldvuer/dist/scaffoldvuer.css'

import DetailsHeader from '@/components/DetailsHeader/DetailsHeader.vue'
import DetailTabs from '@/components/DetailTabs/DetailTabs.vue'

import ProjectSearchResults from '@/components/SearchResults/ProjectSearchResults.vue'
import DatasetSearchResults from '@/components/SearchResults/DatasetSearchResults.vue'

import Scaffolds from '@/static/js/scaffolds.js'

import createClient from '@/plugins/contentful.js'

const client = createClient()

export default {
  name: 'OrganDetails',

  components: {
    DetailsHeader,
    DetailTabs,
    ProjectSearchResults,
    DatasetSearchResults
  },

  async asyncData({ route, $axios }) {
    // Get page content
    const pageData = await client.getEntry(route.params.organId)

    // Get related projects
    const projects = await client.getEntries({
      content_type: process.env.ctf_project_id,
      links_to_entry: route.params.organId
    })

    // Get related datasets
    const organType = pathOr('', ['fields', 'name'], pageData)
    const datasets = await $axios.$get(
      `${
        process.env.discover_api_host
      }/search/datasets?tags=${organType.toLowerCase()}&limit=100`
    )

    return {
      pageData,
      projects: projects.items,
      datasets: datasets.datasets,
      scaffold: Scaffolds[organType.toLowerCase()]
    }
  },

  data() {
    return {
      tabs: [
        {
          label: '3D Scaffold',
          type: '3DScaffold'
        },
        {
          label: 'Datasets',
          type: 'datasets'
        },
        {
          label: 'Projects',
          type: 'projects'
        }
      ],
      activeTab: 'datasets',
      breadcrumb: {
        name: 'data',
        type: 'organ',
        parent: 'Organs'
      },
      scaffold: ''
    }
  },

  computed: {
    /**
     * Compute banner image
     * @returns {String}
     */
    bannerImage: function() {
      return pathOr(
        '',
        ['fields', 'bannerImage', 'fields', 'file', 'url'],
        this.pageData
      )
    },

    /**
     * Compute banner image alt tag
     * @returns {String}
     */
    bannerImageAlt: function() {
      return pathOr(
        '',
        ['fields', 'bannerImage', 'fields', 'description'],
        this.pageData
      )
    }
  },

  methods: {
    /**
     * Sets active tab
     * @param {String} activeLabel
     */
    setActiveTab: function(activeLabel) {
      this.activeTab = activeLabel
    },

    /**
     * Get related datsets
     * @param {String} organ
     */
    getRelatedDatasets: function(organ) {
      const organType = organ.toLowerCase()
      return this.$axios.$get(
        `${process.env.discover_api_host}/search/datasets?tags=${organType}`
      )
    }
  }
}
</script>

<style lang="scss" scoped>
::v-deep {
  .el-table td {
    vertical-align: top;
  }
}
.scaffold {
  height: 500px;
}
</style>
